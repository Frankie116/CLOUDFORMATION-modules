---
# ---------------------------------------------------------------------------------------------------
# version  1.0
# Library: https://github.com/Frankie116/my-library.git
# Creates an Application Load Balancer
# ---------------------------------------------------------------------------------------------------

# req:
# 100-vpc
# 101-ec2
# 103-nat



AWSTemplateFormatVersion: 2010-09-09
Description: This template creates an ALB.  The code is part of a standard modular infrastructure library.



Metadata:

  AWS::CloudFormation::Interface: 
    ParameterGroups:
      - 
        Label: 
          default: "Export VPC Stack Name"
        Parameters:
          - ExportVpcStackName
      - 
        Label: 
          default: "Export Webserver Stack Name"
        Parameters:
          - ExportWebServerStackName



Parameters:

  ExportVpcStackName:
    Description: The name of the vpc stack that exports values
    Type: String
    Default: vpc

  ExportWebServerStackName:
    Description: The name of the ec2 stack that exports values
    Type: String
    Default: ec2



Resources:

  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: MyALB
      SecurityGroups:
        - Fn::ImportValue: !Sub ${ExportVpcStackName}-ALBSecurityGroup
      Subnets: 
        - Fn::ImportValue: !Sub ${ExportVpcStackName}-PublicSubnet1
        - Fn::ImportValue: !Sub ${ExportVpcStackName}-PublicSubnet2

  ALBListenerNoSslCertificate:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroup
      LoadBalancerArn: !Ref ALB
      Port: 80
      Protocol: HTTP

  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: /
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: 200,302
      Name: MyWebServers
      Port: 80
      Protocol: HTTP
      UnhealthyThresholdCount: 5
      Targets:
        - Id:
            Fn::ImportValue: !Sub ${ExportWebServerStackName}-WebServer
      VpcId:
        Fn::ImportValue: !Sub ${ExportVpcStackName}-VPC



Outputs:

  ALBTargetGroup:
    Description: Webserver target group
    Export:
      Name: !Sub ${AWS::StackName}-ALBTargetGroup
    Value: !Ref ALBTargetGroup

  ALBDnsName:
    Description: ALB DNS Name
    Export:
      Name: !Sub ${AWS::StackName}-ALBDnsName
    Value: !GetAtt ALB.DNSName

  ALBZoneID:
    Description: ALB Canonical Hosted Zone ID
    Export:
      Name: !Sub ${AWS::StackName}-ALBZoneID
    Value: !GetAtt ALB.CanonicalHostedZoneID